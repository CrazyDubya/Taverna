<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Living Rusted Tankard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .medieval-font {
            font-family: 'MedievalSharp', cursive;
        }
        .narrative-feed {
            height: calc(100vh - 200px);
        }
        .sidebar {
            height: calc(100vh - 1rem);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="flex h-screen p-4 gap-4">
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-amber-500 medieval-font">The Living Rusted Tankard</h1>
                <button id="settings-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1 rounded">
                    ⚙️ Settings
                </button>
            </header>
            
            <!-- Settings Modal -->
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full">
                    <h2 class="text-xl font-bold text-amber-500 mb-4">Game Settings</h2>
                    
                    <div class="mb-4">
                        <label class="block text-gray-300 mb-2">Claude API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-700 text-white p-2 rounded-lg" 
                               placeholder="sk-ant-api...">
                        <p class="text-xs text-gray-400 mt-1">Required for advanced AI interactions</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-300 mb-2">AI Model</label>
                        <select id="model-select" class="w-full bg-gray-700 text-white p-2 rounded-lg">
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fast)</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Balanced)</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus (Powerful)</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="close-settings-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded">
                            Cancel
                        </button>
                        <button id="save-settings-btn" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded">
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Narrative Feed -->
            <div class="narrative-feed bg-gray-800 p-4 rounded-lg shadow-lg overflow-y-auto mb-4">
                <div id="narrative-content" class="space-y-4">
                    <!-- Narrative messages will be inserted here -->
                    <div class="text-amber-100">Welcome to The Living Rusted Tankard! What would you like to do?</div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="command-input" 
                        class="flex-1 bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                        placeholder="What would you like to do?"
                        autofocus
                    >
                    <button 
                        id="submit-btn"
                        class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="w-80 bg-gray-800 rounded-lg shadow-lg p-4 sidebar overflow-y-auto">
            <!-- Time -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-amber-400 mb-2 border-b border-gray-700 pb-2">Time</h2>
                <div id="game-time" class="text-center text-xl">Morning, Day 1</div>
            </div>
            
            <!-- Gold -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-amber-400 mb-2 border-b border-gray-700 pb-2">Gold</h2>
                <div id="gold-amount" class="flex items-center justify-center">
                    <span class="text-yellow-400 text-2xl">10</span>
                    <span class="ml-1">gp</span>
                </div>
            </div>
            
            <!-- Inventory -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-amber-400 mb-2 border-b border-gray-700 pb-2">Inventory</h2>
                <ul id="inventory-list" class="space-y-1">
                    <li>• Rusty Dagger</li>
                    <li>• Leather Armor</li>
                    <li>• Health Potion (2)</li>
                    <li>• Torch</li>
                </ul>
            </div>
            
            <!-- Active Quests -->
            <div>
                <h2 class="text-lg font-bold text-amber-400 mb-2 border-b border-gray-700 pb-2">Active Quests</h2>
                <ul id="quest-list" class="space-y-2">
                    <li class="bg-gray-700 p-2 rounded">
                        <div class="font-bold">The Missing Ale</div>
                        <div class="text-sm text-gray-300">Find the tavern's stolen ale recipe</div>
                    </li>
                    <li class="bg-gray-700 p-2 rounded">
                        <div class="font-bold">Rat Infestation</div>
                        <div class="text-sm text-gray-300">Clear the cellar of rats (3/5)</div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Game state and session management
        let gameState = {
            time: 'Morning, Day 1',
            gold: 10,
            inventory: [],
            active_bounties: [],
            status_effects: []
        };
        
        let sessionId = localStorage.getItem('gameSessionId');
        let commandHistory = [];
        let historyIndex = -1;
        let isLoading = false;

        // DOM Elements
        const commandInput = document.getElementById('command-input');
        const submitBtn = document.getElementById('submit-btn');
        const narrativeContent = document.getElementById('narrative-content');
        const gameTimeElement = document.getElementById('game-time');
        const goldAmountElement = document.getElementById('gold-amount');
        const inventoryListElement = document.getElementById('inventory-list');
        const questListElement = document.getElementById('quest-list');

        // Add a message to the narrative feed
        function addNarrative(text, isPlayer = false) {
            const message = document.createElement('div');
            message.className = isPlayer 
                ? 'text-amber-300 font-bold' 
                : 'text-gray-200';
            message.textContent = isPlayer ? `> ${text}` : text;
            narrativeContent.appendChild(message);
            narrativeContent.scrollTop = narrativeContent.scrollHeight;
        }

        // Update the UI with the current game state
        function updateUI() {
            // Clear loading state
            setLoading(false);
            
            // Update time
            if (gameState.time) {
                gameTimeElement.textContent = gameState.time;
            }
            
            // Update gold
            if (gameState.gold !== undefined) {
                goldAmountElement.innerHTML = `
                    <span class="text-yellow-400 text-2xl">${gameState.gold}</span>
                    <span class="ml-1">gp</span>
                `;
            }
            
            // Update inventory
            if (gameState.inventory) {
                inventoryListElement.innerHTML = '';
                
                if (Array.isArray(gameState.inventory) && gameState.inventory.length > 0) {
                    gameState.inventory.forEach(item => {
                        const li = document.createElement('li');
                        if (typeof item === 'string') {
                            li.textContent = `• ${item}`;
                        } else if (item.name) {
                            let itemText = `• ${item.name}`;
                            if (item.quantity && item.quantity > 1) {
                                itemText += ` (${item.quantity})`;
                            }
                            li.textContent = itemText;
                        }
                        inventoryListElement.appendChild(li);
                    });
                } else {
                    inventoryListElement.innerHTML = '<li>Your inventory is empty</li>';
                }
            }
            
            // Update quests/bounties
            questListElement.innerHTML = '';
            const bounties = gameState.active_bounties || [];
            
            if (Array.isArray(bounties) && bounties.length > 0) {
                bounties.forEach(bounty => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-2 rounded';
                    
                    // Handle different bounty formats
                    if (typeof bounty === 'string') {
                        // Simple string format
                        li.innerHTML = `<div class="font-bold">${bounty}</div>`;
                    } else if (bounty.title) {
                        // Object with title and description
                        li.innerHTML = `
                            <div class="font-bold">${bounty.title}</div>
                            <div class="text-sm text-gray-300">${bounty.description || ''}</div>
                        `;
                    }
                    
                    questListElement.appendChild(li);
                });
            } else {
                questListElement.innerHTML = '<li class="italic text-gray-400">No active quests</li>';
            }
        }
        
        // Set loading state
        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerText = 'Sending...';
                submitBtn.classList.add('opacity-50');
                commandInput.disabled = true;
            } else {
                submitBtn.disabled = false;
                submitBtn.innerText = 'Send';
                submitBtn.classList.remove('opacity-50');
                commandInput.disabled = false;
                commandInput.focus();
            }
        }

        // Fetch the current game state from the server
        async function fetchGameState() {
            if (!sessionId) {
                // Create a new session first by sending an empty command
                await sendCommand('help');
                return;
            }
            
            try {
                setLoading(true);
                const response = await fetch(`/state/${sessionId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Session not found, reset and create a new one
                        localStorage.removeItem('gameSessionId');
                        sessionId = null;
                        addNarrative('Starting a new game session...');
                        await sendCommand('help');
                        return;
                    }
                    throw new Error(`Server responded with ${response.status}`);
                }
                
                const data = await response.json();
                gameState = data.game_state;
                updateUI();
                
                // Process any events
                if (data.events && data.events.length > 0) {
                    data.events.forEach(event => {
                        addNarrative(event.message || event.text || 'Event occurred');
                    });
                }
            } catch (error) {
                console.error('Error fetching game state:', error);
                addNarrative('Error connecting to the game server. Please try refreshing the page.');
                setLoading(false);
            }
        }

        // Send a command to the server
        async function sendCommand(command) {
            try {
                setLoading(true);
                
                // Add to command history
                if (command.trim() && (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command)) {
                    commandHistory.push(command);
                    historyIndex = commandHistory.length;
                }
                
                const response = await fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        input: command,
                        session_id: sessionId
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save session ID
                if (data.session_id && (!sessionId || sessionId !== data.session_id)) {
                    sessionId = data.session_id;
                    localStorage.setItem('gameSessionId', sessionId);
                    console.log(`Game session ID: ${sessionId}`);
                }
                
                // Update game state
                gameState = data.game_state;
                updateUI();
                
                // Add response to narrative
                if (data.output) {
                    addNarrative(data.output);
                }
                
                // Process any events
                if (data.events && data.events.length > 0) {
                    data.events.forEach(event => {
                        addNarrative(event.message || event.text || 'Event occurred');
                    });
                }
            } catch (error) {
                console.error('Error sending command:', error);
                addNarrative('Error sending command to the server. Please try again.');
                setLoading(false);
            }
        }
        
        // Navigate command history
        function navigateHistory(direction) {
            if (commandHistory.length === 0) return;
            
            if (direction === 'up') {
                historyIndex = Math.max(0, historyIndex - 1);
            } else if (direction === 'down') {
                historyIndex = Math.min(commandHistory.length, historyIndex + 1);
            }
            
            if (historyIndex < commandHistory.length) {
                commandInput.value = commandHistory[historyIndex];
            } else {
                commandInput.value = '';
            }
        }

        // Handle command input
        function handleCommand() {
            const command = commandInput.value.trim();
            if (!command) return;

            // Add player command to narrative
            addNarrative(command, true);
            commandInput.value = '';

            // Send command to server
            sendCommand(command);
        }

        // LLM API configuration functions
        async function saveLLMSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            
            if (!apiKey) {
                alert('API Key is required for AI-powered interactions');
                return;
            }
            
            try {
                setLoading(true);
                const response = await fetch('/llm-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        model: model
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    // Save API key to localStorage (note: in a real app, consider security implications)
                    localStorage.setItem('llm_api_key', apiKey);
                    localStorage.setItem('llm_model', model);
                    
                    // Close the modal
                    toggleSettingsModal(false);
                    
                    // Show success message
                    addNarrative(`AI Game Master activated using ${model}! You can now interact in natural language.`, false);
                } else {
                    alert('Failed to update LLM settings: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving LLM settings:', error);
                alert('Error saving settings: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        function toggleSettingsModal(show) {
            const modal = document.getElementById('settings-modal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            // Set up command input event listeners
            commandInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleCommand();
                } else if (e.key === 'ArrowUp') {
                    navigateHistory('up');
                    e.preventDefault();
                } else if (e.key === 'ArrowDown') {
                    navigateHistory('down');
                    e.preventDefault();
                }
            });
            
            submitBtn.addEventListener('click', handleCommand);
            
            // Set up settings modal handlers
            document.getElementById('settings-btn').addEventListener('click', () => {
                // Load saved values if available
                const savedApiKey = localStorage.getItem('llm_api_key') || '';
                const savedModel = localStorage.getItem('llm_model') || 'claude-3-haiku-20240307';
                
                document.getElementById('api-key-input').value = savedApiKey;
                document.getElementById('model-select').value = savedModel;
                
                toggleSettingsModal(true);
            });
            
            document.getElementById('close-settings-btn').addEventListener('click', () => {
                toggleSettingsModal(false);
            });
            
            document.getElementById('save-settings-btn').addEventListener('click', saveLLMSettings);
            
            // Load initial game state
            fetchGameState();
            
            // Focus the input field
            commandInput.focus();
            
            // Add welcome message
            addNarrative('Welcome to The Living Rusted Tankard! Type "help" to see available commands.');
            
            // Check if LLM API key is saved, and if so, apply it automatically
            const savedApiKey = localStorage.getItem('llm_api_key');
            const savedModel = localStorage.getItem('llm_model');
            if (savedApiKey && savedModel) {
                fetch('/llm-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: savedApiKey,
                        model: savedModel
                    }),
                }).then(response => {
                    if (response.ok) {
                        addNarrative(`AI Game Master activated with ${savedModel}! You can interact using natural language.`, false);
                    }
                }).catch(error => {
                    console.error('Error applying saved LLM settings:', error);
                });
            } else {
                // Show a prompt to set up API key
                addNarrative('For enhanced AI Game Master features, click the ⚙️ Settings button and enter your Claude API key.', false);
            }
        });
    </script>
</body>
</html>
