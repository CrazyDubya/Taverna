<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Living Rusted Tankard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS Custom Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'medieval': ['MedievalSharp', 'cursive'],
                        'cinzel': ['Cinzel', 'serif']
                    },
                    colors: {
                        'tavern': {
                            50: '#fdf4e3',
                            100: '#fbe8c7',
                            200: '#f7d18f',
                            300: '#f3ba57',
                            400: '#efa31f',
                            500: '#d68c0a',
                            600: '#b47006',
                            700: '#925404',
                            800: '#703f03',
                            900: '#4e2b02',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-gentle': 'pulseGentle 2s ease-in-out infinite',
                        'bounce-subtle': 'bounceSubtle 1s ease-in-out',
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseGentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes bounceSubtle {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        .narrative-feed {
            height: calc(100vh - 280px);
            min-height: 400px;
        }
        
        .sidebar {
            height: calc(100vh - 2rem);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .narrative-feed {
                height: calc(100vh - 200px);
                min-height: 300px;
            }
            
            .sidebar {
                height: auto;
                max-height: 50vh;
            }
            
            .desktop-layout {
                flex-direction: column;
            }
            
            .mobile-sidebar {
                order: 2;
                width: 100%;
                margin-top: 1rem;
            }
            
            .mobile-main {
                order: 1;
                width: 100%;
            }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        
        /* Typography improvements */
        .narrative-text {
            line-height: 1.7;
            font-size: 1.1rem;
        }
        
        /* Loading animation */
        .loading-dots::after {
            content: '';
            animation: loadingDots 1.5s infinite;
        }
        
        @keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Command history styling */
        .command-history {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
        }
        
        /* Enhanced button styles */
        .btn-primary {
            background: linear-gradient(135deg, #d68c0a 0%, #efa31f 100%);
            transition: all 0.3s ease;
            border: 1px solid #b47006;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #b47006 0%, #d68c0a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(214, 140, 10, 0.3);
        }
        
        /* Message styling improvements */
        .message-welcome {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .message-narrative {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-left: 3px solid #6b7280;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin: 0.25rem 0;
        }
        
        .message-system {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
            border-left: 3px solid #10b981;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
            font-size: 0.875rem;
        }
        
        /* Remove non-functional sound styles */
        .audio-controls {
            display: none;
        }
        
        /* Status indicators */
        .status-online {
            background: #10B981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .status-offline {
            background: #EF4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .status-degraded {
            background: #F59E0B;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-200 min-h-screen">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 bg-tavern-500 text-white px-4 py-2 rounded shadow-lg ring-2 ring-white font-bold transition-all">Skip to main content</a>
    <div class="flex desktop-layout h-screen p-2 md:p-4 gap-2 md:gap-4">
        <!-- Main Content -->
        <div class="flex-1 mobile-main flex flex-col">
            <!-- Enhanced Header -->
            <header class="bg-gradient-to-r from-gray-800 to-gray-700 p-3 md:p-4 rounded-lg shadow-xl mb-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl md:text-3xl font-bold text-tavern-400 font-medieval">
                        üç∫ The Living Rusted Tankard
                    </h1>
                    <div id="connection-status" role="status" aria-live="polite" aria-label="Connection Status: Online" class="w-3 h-3 rounded-full status-online" title="Connected"></div>
                </div>
                
                <div class="flex items-center space-x-2">
                    
                    <!-- Mobile Menu Toggle -->
                    <button id="mobile-menu-toggle" aria-label="View status and inventory" class="md:hidden bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-tavern-400">
                        ‚ò∞
                    </button>
                    
                    <!-- Settings Button -->
                    <button id="settings-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-2 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-tavern-400">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </header>
            
            <!-- Enhanced Narrative Feed -->
            <div id="main-content" tabindex="-1" class="relative flex-1 bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg shadow-lg overflow-hidden border border-gray-700 outline-none">
                <div id="narrative-content" aria-live="polite" aria-atomic="false" role="log" class="narrative-feed overflow-y-auto p-4 md:p-6 space-y-4 custom-scrollbar">
                    <!-- Initial loading message - real welcome comes from server -->
                    <div id="initial-loading" class="bg-gradient-to-r from-tavern-900 to-gray-800 border-l-4 border-tavern-400 p-4 rounded-r-lg animate-fade-in text-center">
                        <div class="font-cinzel text-lg text-tavern-300 mb-2">üç∫ The Living Rusted Tankard</div>
                        <p class="narrative-text text-gray-400 italic">
                            Preparing your adventure...
                        </p>
                        <div class="mt-3 text-tavern-400 animate-pulse-gentle">
                            ‚öôÔ∏è Loading game world...
                        </div>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden p-2 text-center text-tavern-400">
                    <span class="loading-dots">Weaving the tale</span>
                </div>

                <!-- Scroll to Bottom Button -->
                <button id="scroll-bottom-btn" aria-label="Scroll to bottom" class="hidden absolute bottom-4 right-4 bg-gray-700 hover:bg-tavern-500 text-white p-3 rounded-full shadow-lg transition-all border border-gray-600 focus:outline-none focus:ring-2 focus:ring-tavern-400 z-10 animate-fade-in" title="Scroll to bottom">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                </button>
            </div>
            
            <!-- Enhanced Command Input -->
            <div class="mt-4 space-y-2">
                <!-- Command History Toggle -->
                <div class="flex justify-between items-center">
                    <button id="history-toggle" aria-expanded="false" aria-controls="command-history-panel" class="text-sm text-gray-400 hover:text-tavern-400 transition-colors focus:outline-none focus:ring-2 focus:ring-tavern-400 rounded px-1">
                        üìú Command History (0)
                    </button>
                    <button id="clear-history" class="text-sm text-gray-400 hover:text-red-400 transition-colors focus:outline-none focus:ring-2 focus:ring-tavern-400 rounded px-1">
                        üóëÔ∏è Clear
                    </button>
                </div>
                
                <!-- Command History Panel -->
                <div id="command-history-panel" class="hidden command-history rounded-lg p-3 max-h-32 overflow-y-auto custom-scrollbar">
                    <div id="command-history-list" class="space-y-1 text-sm">
                        <!-- History items will be populated here -->
                    </div>
                </div>
                
                <!-- Enhanced Input Area -->
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="command-input" 
                            aria-label="Command input"
                            autofocus
                            placeholder="What would you like to do? (e.g., 'look around', 'talk to barkeeper', 'buy ale')"
                            class="w-full bg-gray-700 text-white p-3 md:p-4 rounded-lg border border-gray-600 focus:border-tavern-400 focus:ring-2 focus:ring-tavern-400/20 outline-none transition-all text-base"
                            autocomplete="off"
                        >
                        <!-- Input suggestions -->
                        <div id="input-suggestions" class="hidden absolute bottom-full left-0 right-0 mb-1 bg-gray-700 border border-gray-600 rounded-lg shadow-xl max-h-40 overflow-y-auto">
                            <!-- Suggestions will be populated here -->
                        </div>
                    </div>
                    
                    <button 
                        id="submit-btn" 
                        aria-label="Send command"
                        class="btn-primary text-white px-6 md:px-8 py-3 md:py-4 rounded-lg font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-tavern-400"
                        disabled
                    >
                        <span class="hidden md:inline">Send</span>
                        <span class="md:hidden">‚Üí</span>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div id="quick-actions" class="flex flex-wrap gap-2 mt-2">
                    <button class="quick-action bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tavern-400" data-command="look">
                        üëÄ Look Around
                    </button>
                    <button class="quick-action bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tavern-400" data-command="status">
                        üìä Check Status
                    </button>
                    <button class="quick-action bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tavern-400" data-command="inventory">
                        üéí My Items
                    </button>
                    <button class="quick-action bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tavern-400" data-command="talk to barkeeper">
                        üí¨ Chat
                    </button>
                    <button class="quick-action bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tavern-400" data-command="help">
                        ‚ùì Help
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Sidebar -->
        <aside id="sidebar" class="w-full mobile-sidebar md:w-80 bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg shadow-xl p-4 sidebar overflow-y-auto custom-scrollbar border border-gray-700">
            <!-- Performance Indicator -->
            <div class="mb-4 p-2 bg-gray-700 rounded-lg">
                <div class="flex justify-between items-center text-xs text-gray-400">
                    <span>Performance</span>
                    <span id="performance-indicator" class="text-green-400">‚ö° Optimized</span>
                </div>
            </div>
            
            <!-- Enhanced Time Display -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-tavern-400 mb-3 border-b border-gray-700 pb-2 font-cinzel flex items-center">
                    üïê Time
                </h2>
                <div id="game-time" class="text-center text-xl font-medieval bg-gray-700 rounded-lg p-3 text-tavern-300">
                    Morning, Day 1
                </div>
            </div>
            
            <!-- Enhanced Gold Display -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-tavern-400 mb-3 border-b border-gray-700 pb-2 font-cinzel flex items-center">
                    üí∞ Gold
                </h2>
                <div id="gold-amount" class="flex items-center justify-center bg-gray-700 rounded-lg p-3">
                    <span class="text-yellow-400 text-2xl font-bold animate-pulse-gentle">10</span>
                    <span class="ml-2 text-yellow-300">gp</span>
                </div>
            </div>
            
            <!-- Enhanced Inventory -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-tavern-400 mb-3 border-b border-gray-700 pb-2 font-cinzel flex items-center">
                    üéí Inventory
                    <span id="inventory-count" class="ml-2 text-sm bg-gray-600 px-2 py-1 rounded-full">0</span>
                </h2>
                <div id="inventory-container" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                    <ul id="inventory-list" class="space-y-1">
                        <li class="text-gray-400 text-sm italic">Your pack is empty</li>
                    </ul>
                </div>
            </div>
            
            <!-- Enhanced Active Quests -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-tavern-400 mb-3 border-b border-gray-700 pb-2 font-cinzel flex items-center">
                    üìú Active Quests
                    <span id="quest-count" class="ml-2 text-sm bg-gray-600 px-2 py-1 rounded-full">0</span>
                </h2>
                <div id="quest-container" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                    <ul id="quest-list" class="space-y-2">
                        <li class="text-gray-400 text-sm italic">No active quests</li>
                    </ul>
                </div>
            </div>
            
            <!-- Memory Indicator -->
            <div id="memory-indicator" class="text-center p-3 bg-gray-700 rounded-lg">
                <div class="text-sm text-gray-400">Story Memory</div>
                <div class="text-tavern-400 font-bold">üìö Active</div>
            </div>
        </aside>
    </div>

    <!-- Enhanced Settings Modal -->
    <div id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-title" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gradient-to-b from-gray-800 to-gray-900 p-6 rounded-xl shadow-2xl max-w-md w-full border border-gray-600">
            <h2 id="settings-title" class="text-xl font-bold text-tavern-400 mb-6 font-cinzel">‚öôÔ∏è Game Settings</h2>
            
            <!-- LLM Configuration -->
            <div class="space-y-4">
                <div>
                    <label for="ollama-url-input" class="block text-gray-300 mb-2 font-semibold cursor-pointer">Ollama URL</label>
                    <input type="text" id="ollama-url-input" 
                           class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:border-tavern-400 focus:ring-2 focus:ring-tavern-400/20" 
                           placeholder="http://localhost:11434" value="http://localhost:11434">
                    <p class="text-xs text-gray-400 mt-1">URL of your Ollama server</p>
                </div>
                
                <div>
                    <label for="model-select" class="block text-gray-300 mb-2 font-semibold cursor-pointer">AI Model</label>
                    <select id="model-select" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:border-tavern-400">
                        <option value="long-gemma:latest">long-gemma:latest</option>
                        <option value="llama3:8b">llama3:8b</option>
                        <option value="llama3.1:8b">llama3.1:8b</option>
                        <option value="mistral-small:24b">mistral-small:24b</option>
                    </select>
                </div>
                
                
                <!-- Performance Settings -->
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Performance</label>
                    <label class="flex items-center">
                        <input type="checkbox" id="performance-optimizations" class="mr-2" checked>
                        <span class="text-sm">Enable performance optimizations</span>
                    </label>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="save-settings" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold">
                    Save Settings
                </button>
                <button id="close-settings" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg font-semibold transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <script>
        // Enhanced game state management with UX improvements
        class EnhancedGameInterface {
            constructor() {
                this.gameState = {
                    time: 'Morning, Day 1',
                    gold: 10,
                    inventory: [],
                    active_bounties: [],
                    status_effects: []
                };
                
                this.commonCommands = [
                    'look', 'look around', 'inventory', 'status', 'help',
                    'talk to barkeeper', 'buy ale', 'quests', 'sleep', 'map'
                ];

                this.commandHints = [
                    "What would you like to do?",
                    "Try 'look around' to see your surroundings",
                    "Try 'inventory' to check your gear",
                    "Try 'status' to check your health",
                    "Try 'talk to barkeeper' to chat",
                    "Try 'help' to see all commands"
                ];

                this.sessionId = localStorage.getItem('gameSessionId');
                this.commandHistory = JSON.parse(localStorage.getItem('commandHistory') || '[]');
                this.historyIndex = -1;
                this.isLoading = false;
                this.performanceOptimized = localStorage.getItem('performanceOptimized') !== 'false';
                
                this.initializeInterface();
                this.bindEvents();
                this.loadSettings();
                this.updateCommandHistoryDisplay();
            }
            
            initializeInterface() {
                this.elements = {
                    commandInput: document.getElementById('command-input'),
                    submitBtn: document.getElementById('submit-btn'),
                    narrativeContent: document.getElementById('narrative-content'),
                    gameTimeElement: document.getElementById('game-time'),
                    goldAmountElement: document.getElementById('gold-amount'),
                    inventoryListElement: document.getElementById('inventory-list'),
                    questListElement: document.getElementById('quest-list'),
                    memoryIndicator: document.getElementById('memory-indicator'),
                    loadingIndicator: document.getElementById('loading-indicator'),
                    connectionStatus: document.getElementById('connection-status'),
                    performanceIndicator: document.getElementById('performance-indicator'),
                    historyToggle: document.getElementById('history-toggle'),
                    historyPanel: document.getElementById('command-history-panel'),
                    historyList: document.getElementById('command-history-list'),
                    inputSuggestions: document.getElementById('input-suggestions'),
                    scrollBottomBtn: document.getElementById('scroll-bottom-btn')
                };
                
                // Enable submit button when there's input
                this.elements.commandInput.addEventListener('input', (e) => {
                    this.elements.submitBtn.disabled = !this.elements.commandInput.value.trim();
                    this.showSuggestions(e.target.value);
                });

                // Close suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.elements.inputSuggestions.contains(e.target) && e.target !== this.elements.commandInput) {
                        this.elements.inputSuggestions.classList.add('hidden');
                    }
                });
                
                // Initialize with session if available
                if (!this.sessionId) {
                    this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('gameSessionId', this.sessionId);
                }
                
                // Remove the initial loading message and start the game
                setTimeout(() => {
                    const initialLoading = document.getElementById('initial-loading');
                    if (initialLoading) {
                        initialLoading.remove();
                    }
                    // Get initial game state instead of sending a command
                    this.initializeGameSession();
                    this.startHintCycle();
                }, 1000);
            }

            startHintCycle() {
                let index = 0;
                setInterval(() => {
                    if (!this.elements.commandInput.value) {
                        index = (index + 1) % this.commandHints.length;
                        this.elements.commandInput.placeholder = this.commandHints[index];
                    }
                }, 3000);
            }
            
            async initializeGameSession() {
                try {
                    // Send a simple initial command to get the welcome message
                    const response = await this.sendCommand('look around');
                    this.handleCommandResponse(response);
                } catch (error) {
                    console.error('Failed to initialize session:', error);
                    // Show a fallback welcome message\n                    this.addNarrative('üç∫ Welcome to The Living Rusted Tankard! The game is ready to begin. Type \"help\" to see available commands.', false, 'welcome');\n                    // Update the game state display with defaults\n                    this.updateGameState({\n                        time: { formatted: 'Morning, Day 1' },\n                        player: { gold: 20, inventory: [] },\n                        active_bounties: []\n                    });
                }
            }
            
            bindEvents() {
                // Command submission
                this.elements.submitBtn.addEventListener('click', () => this.submitCommand());
                this.elements.commandInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.submitCommand();
                    }
                });
                
                // Command history navigation
                this.elements.commandInput.addEventListener('keydown', (e) => {
                    const suggestionsVisible = !this.elements.inputSuggestions.classList.contains('hidden');

                    if (suggestionsVisible) {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const firstBtn = this.elements.inputSuggestions.querySelector('button');
                            if (firstBtn) firstBtn.focus();
                            return;
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            this.elements.inputSuggestions.classList.add('hidden');
                            return;
                        }
                    }

                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        this.navigateHistory('up');
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        this.navigateHistory('down');
                    }
                });
                
                // History panel toggle with aria-expanded
                this.elements.historyToggle.addEventListener('click', () => {
                    const isHidden = this.elements.historyPanel.classList.toggle('hidden');
                    this.elements.historyToggle.setAttribute('aria-expanded', !isHidden);
                });
                
                // Clear history
                document.getElementById('clear-history').addEventListener('click', () => {
                    this.commandHistory = [];
                    localStorage.setItem('commandHistory', '[]');
                    this.updateCommandHistoryDisplay();
                });
                
                // Quick actions
                document.querySelectorAll('.quick-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const command = btn.dataset.command;
                        this.elements.commandInput.value = command;
                        this.elements.submitBtn.disabled = false;
                        this.submitCommand();
                    });
                });
                
                // Settings modal with focus management
                const settingsModal = document.getElementById('settings-modal');
                const settingsBtn = document.getElementById('settings-btn');
                const closeSettingsBtn = document.getElementById('close-settings');
                const ollamaUrlInput = document.getElementById('ollama-url-input');
                let previouslyFocusedElement = null;
                
                // Open settings modal
                const openSettings = () => {
                    // Save currently focused element
                    previouslyFocusedElement = document.activeElement;
                    
                    // Show modal
                    settingsModal.classList.remove('hidden');
                    
                    // Move focus to first input field
                    setTimeout(() => {
                        ollamaUrlInput.focus();
                    }, 100);
                };
                
                // Close settings modal
                const closeSettings = () => {
                    settingsModal.classList.add('hidden');
                    
                    // Restore focus to previously focused element
                    if (previouslyFocusedElement) {
                        previouslyFocusedElement.focus();
                    }
                };
                
                settingsBtn.addEventListener('click', openSettings);
                closeSettingsBtn.addEventListener('click', closeSettings);
                
                // Focus trap and Escape key for settings modal
                settingsModal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        const focusableElements = settingsModal.querySelectorAll(
                            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                        );
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];

                        if (e.shiftKey) { /* shift + tab */
                            if (document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            }
                        } else { /* tab */
                            if (document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    } else if (e.key === 'Escape') {
                        closeSettings();
                    }
                });
                
                document.getElementById('save-settings').addEventListener('click', () => {
                    this.saveSettings();
                    closeSettings();
                });
                
                
                // Mobile menu
                document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
                    document.getElementById('sidebar').scrollIntoView({ behavior: 'smooth' });
                });

                // Scroll to bottom button
                this.elements.scrollBottomBtn.addEventListener('click', () => {
                    this.scrollToBottom();
                });

                // Scroll listener for narrative content
                let scrollTimeout;
                this.elements.narrativeContent.addEventListener('scroll', () => {
                    if (scrollTimeout) return;
                    scrollTimeout = setTimeout(() => {
                        this.updateScrollButtonVisibility();
                        scrollTimeout = null;
                    }, 100);
                });
            }
            
            updateScrollButtonVisibility() {
                const el = this.elements.narrativeContent;
                // Show button if we are scrolled up more than 150px from the bottom
                const isScrolledUp = el.scrollHeight - el.scrollTop - el.clientHeight > 150;

                if (isScrolledUp) {
                    this.elements.scrollBottomBtn.classList.remove('hidden');
                } else {
                    this.elements.scrollBottomBtn.classList.add('hidden');
                }
            }

            async submitCommand() {
                const command = this.elements.commandInput.value.trim();
                if (!command) return;
                
                // Add to command history
                if (this.commandHistory[this.commandHistory.length - 1] !== command) {
                    this.commandHistory.push(command);
                    if (this.commandHistory.length > 50) {
                        this.commandHistory.shift();
                    }
                    localStorage.setItem('commandHistory', JSON.stringify(this.commandHistory));
                    this.updateCommandHistoryDisplay();
                }
                
                // Reset history navigation
                this.historyIndex = -1;
                
                // Show user command
                this.addNarrative(`> ${command}`, true);
                
                // Clear input and show loading
                this.elements.commandInput.value = '';
                this.elements.submitBtn.disabled = true;
                this.showLoading(true);
                
                try {
                    const response = await this.sendCommand(command);
                    this.handleCommandResponse(response);
                } catch (error) {
                    this.handleError(error);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async sendCommand(command) {
                const response = await fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: command,
                        session_id: this.sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
            
            handleCommandResponse(response) {
                // Update connection status
                this.updateConnectionStatus('online');
                
                // Add narrative response
                this.addNarrative(response.output);
                
                // Update game state
                if (response.game_state) {
                    this.updateGameState(response.game_state);
                }
                
                // Handle events
                if (response.events) {
                    this.handleEvents(response.events);
                }
                
            }
            
            handleError(error) {
                console.error('Command error:', error);
                this.updateConnectionStatus('offline');
                this.addNarrative(`üîß Something went wrong: ${error.message}. The tavern's magic seems disrupted.`);
            }
            
            addNarrative(text, isPlayer = false, messageType = null) {
                const message = document.createElement('div');
                
                let className = 'animate-fade-in ';
                if (isPlayer) {
                    className += 'text-tavern-300 font-bold bg-gray-700 p-3 rounded-lg border-l-4 border-tavern-400';
                } else {
                    // Determine message type from content if not provided
                    if (!messageType) {
                        if (text.includes('Welcome to') || text.includes('heavy wooden door')) {
                            messageType = 'welcome';
                        } else if (text.includes('‚öôÔ∏è') || text.includes('üíæ') || text.includes('Loading')) {
                            messageType = 'system';
                        } else {
                            messageType = 'narrative';
                        }
                    }
                    
                    switch (messageType) {
                        case 'welcome':
                            className += 'message-welcome text-blue-100';
                            break;
                        case 'system':
                            className += 'message-system text-green-100';
                            break;
                        default:
                            className += 'message-narrative text-gray-200 narrative-text';
                    }
                }
                
                message.className = className;
                
                // Handle conversation options
                const optionsRegex = /\[options?:\s*([^\]]+)\]/i;
                const optionsMatch = text.match(optionsRegex);
                
                if (!isPlayer && optionsMatch) {
                    const narrativeText = text.replace(optionsRegex, '').trim();
                    message.innerHTML = this.formatNarrativeText(narrativeText);
                    this.elements.narrativeContent.appendChild(message);
                    
                    // Create conversation options
                    this.createConversationOptions(optionsMatch[1]);
                } else {
                    message.innerHTML = this.formatNarrativeText(text);
                    this.elements.narrativeContent.appendChild(message);
                }
                
                // Auto-scroll to bottom
                this.scrollToBottom();
            }
            
            formatNarrativeText(text) {
                // Add some text formatting enhancements
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-tavern-300">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="text-gray-300">$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-700 px-1 rounded text-tavern-300">$1</code>');
            }
            
            createConversationOptions(optionsText) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg p-4 mt-3 mb-4 border border-gray-600 animate-slide-up';
                
                const title = document.createElement('div');
                title.className = 'text-tavern-400 font-semibold mb-3 font-cinzel';
                title.textContent = 'üí≠ Conversation Options:';
                optionsContainer.appendChild(title);
                
                const optionsList = document.createElement('div');
                optionsList.className = 'space-y-2';
                
                // Parse options (handle both single-line and multi-line formats)
                const options = this.parseConversationOptions(optionsText);
                
                options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'w-full text-left p-3 bg-gray-600 hover:bg-gray-500 rounded-lg transition-all transform hover:scale-102 border border-gray-500 hover:border-tavern-400';
                    optionBtn.innerHTML = `<span class="text-tavern-300 font-bold">${index + 1}.</span> <span class="text-gray-200">${option}</span>`;
                    
                    optionBtn.addEventListener('click', () => {
                        this.elements.commandInput.value = option;
                        this.elements.submitBtn.disabled = false;
                        this.submitCommand();
                    });
                    
                    optionsList.appendChild(optionBtn);
                });
                
                optionsContainer.appendChild(optionsList);
                this.elements.narrativeContent.appendChild(optionsContainer);
            }
            
            parseConversationOptions(optionsText) {
                // Handle numbered options
                const numberedOptions = optionsText.match(/\d+\.\s*([^0-9]+?)(?=\s*\d+\.|$)/g);
                if (numberedOptions) {
                    return numberedOptions.map(opt => opt.replace(/^\d+\.\s*/, '').trim());
                }
                
                // Handle simple comma/semicolon separated options
                return optionsText.split(/[,;]/).map(opt => opt.trim()).filter(opt => opt);
            }
            
            updateGameState(state) {
                // Update time
                if (state.time) {
                    this.elements.gameTimeElement.textContent = state.time.formatted || state.time;
                }
                
                // Update gold with animation
                if (state.player && typeof state.player.gold !== 'undefined') {
                    const goldElement = this.elements.goldAmountElement.querySelector('span');
                    if (goldElement) {
                        const currentGold = parseInt(goldElement.textContent);
                        const newGold = state.player.gold;
                        
                        if (newGold !== currentGold) {
                            goldElement.classList.add('animate-bounce-subtle');
                            setTimeout(() => goldElement.classList.remove('animate-bounce-subtle'), 1000);
                        }
                        
                        goldElement.textContent = newGold;
                    }
                }
                
                // Update inventory
                if (state.player && state.player.inventory) {
                    this.updateInventoryDisplay(state.player.inventory);
                }
                
                // Update quests
                if (state.active_bounties) {
                    this.updateQuestsDisplay(state.active_bounties);
                }
            }
            
            updateInventoryDisplay(inventory) {
                const container = this.elements.inventoryListElement;
                const countElement = document.getElementById('inventory-count');
                
                if (!inventory || inventory.length === 0) {
                    container.innerHTML = '<li class="text-gray-400 text-sm italic">Your pack is empty</li>';
                    countElement.textContent = '0';
                    return;
                }
                
                container.innerHTML = '';
                countElement.textContent = inventory.length;
                
                inventory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-gray-700 p-2 rounded text-sm animate-fade-in';
                    li.innerHTML = `
                        <span class="text-gray-200">${item.name || item}</span>
                        ${item.quantity ? `<span class="text-tavern-400 text-xs">√ó${item.quantity}</span>` : ''}
                    `;
                    container.appendChild(li);
                });
            }
            
            updateQuestsDisplay(quests) {
                const container = this.elements.questListElement;
                const countElement = document.getElementById('quest-count');
                
                if (!quests || quests.length === 0) {
                    container.innerHTML = '<li class="text-gray-400 text-sm italic">No active quests</li>';
                    countElement.textContent = '0';
                    return;
                }
                
                container.innerHTML = '';
                countElement.textContent = quests.length;
                
                quests.forEach(quest => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded-lg border-l-4 border-tavern-400 animate-fade-in';
                    li.innerHTML = `
                        <div class="font-bold text-tavern-300">${quest.title || quest.name}</div>
                        <div class="text-sm text-gray-300 mt-1">${quest.description || 'Quest in progress...'}</div>
                        ${quest.progress ? `<div class="text-xs text-tavern-400 mt-2">Progress: ${quest.progress}</div>` : ''}
                    `;
                    container.appendChild(li);
                });
            }
            
            updateCommandHistoryDisplay() {
                const historyList = this.elements.historyList;
                const historyToggle = this.elements.historyToggle;
                
                historyToggle.textContent = `üìú Command History (${this.commandHistory.length})`;
                
                if (this.commandHistory.length === 0) {
                    historyList.innerHTML = '<div class="text-gray-400 text-sm italic">No commands yet</div>';
                    return;
                }
                
                historyList.innerHTML = '';
                
                // Show last 10 commands
                const recentHistory = this.commandHistory.slice(-10);
                recentHistory.forEach((command, index) => {
                    const button = document.createElement('button');
                    button.className = 'text-gray-300 hover:text-tavern-400 cursor-pointer p-1 rounded hover:bg-gray-600 transition-all focus:outline-none focus:ring-2 focus:ring-tavern-400 text-left w-full';
                    button.textContent = command;
                    button.setAttribute('type', 'button');
                    button.setAttribute('aria-label', `Use command: ${command}`);
                    button.addEventListener('click', () => {
                        this.elements.commandInput.value = command;
                        this.elements.submitBtn.disabled = false;
                        this.elements.historyPanel.classList.add('hidden');
                        this.elements.historyToggle.setAttribute('aria-expanded', 'false');
                        // Return focus to command input
                        this.elements.commandInput.focus();
                    });
                    historyList.appendChild(button);
                });
            }
            
            navigateHistory(direction) {
                if (this.commandHistory.length === 0) return;
                
                if (direction === 'up') {
                    if (this.historyIndex === -1) {
                        this.historyIndex = this.commandHistory.length - 1;
                    } else if (this.historyIndex > 0) {
                        this.historyIndex--;
                    }
                } else if (direction === 'down') {
                    if (this.historyIndex === -1) return;
                    if (this.historyIndex < this.commandHistory.length - 1) {
                        this.historyIndex++;
                    } else {
                        this.historyIndex = -1;
                        this.elements.commandInput.value = '';
                        return;
                    }
                }
                
                if (this.historyIndex >= 0) {
                    this.elements.commandInput.value = this.commandHistory[this.historyIndex];
                    this.elements.submitBtn.disabled = false;
                }
            }
            
            updateConnectionStatus(status) {
                const statusElement = this.elements.connectionStatus;
                statusElement.className = `w-3 h-3 rounded-full status-${status}`;
                
                const statusText = {
                    'online': 'Connected',
                    'offline': 'Disconnected', 
                    'degraded': 'Degraded'
                };
                
                const text = statusText[status] || 'Unknown';
                statusElement.title = text;
                statusElement.setAttribute('aria-label', `Connection Status: ${text}`);
            }
            
            showSuggestions(input) {
                const value = input.toLowerCase().trim();
                this.elements.inputSuggestions.innerHTML = '';

                if (!value) {
                    this.elements.inputSuggestions.classList.add('hidden');
                    return;
                }

                const matches = this.commonCommands.filter(cmd =>
                    cmd.toLowerCase().includes(value) && cmd.toLowerCase() !== value
                );

                if (matches.length === 0) {
                    this.elements.inputSuggestions.classList.add('hidden');
                    return;
                }

                matches.forEach(match => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full text-left p-2 hover:bg-gray-600 cursor-pointer text-gray-300 hover:text-white transition-colors border-b border-gray-600 last:border-0 focus:outline-none focus:bg-gray-600';
                    const regex = new RegExp(`(${value})`, 'gi');
                    btn.innerHTML = match.replace(regex, '<span class="text-tavern-400 font-bold">$1</span>');

                    btn.addEventListener('click', () => {
                        this.elements.commandInput.value = match;
                        this.elements.submitBtn.disabled = false;
                        this.elements.inputSuggestions.classList.add('hidden');
                        this.elements.commandInput.focus();
                    });

                    // Keyboard navigation for suggestions
                    btn.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const next = btn.nextElementSibling;
                            if (next) next.focus();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const prev = btn.previousElementSibling;
                            if (prev) {
                                prev.focus();
                            } else {
                                this.elements.commandInput.focus();
                            }
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            this.elements.inputSuggestions.classList.add('hidden');
                            this.elements.commandInput.focus();
                        }
                    });

                    this.elements.inputSuggestions.appendChild(btn);
                });

                this.elements.inputSuggestions.classList.remove('hidden');
            }

            showLoading(show) {
                this.isLoading = show;
                this.elements.loadingIndicator.classList.toggle('hidden', !show);
                this.elements.submitBtn.disabled = show || !this.elements.commandInput.value.trim();

                if (show) {
                    // Save original content if not already saved
                    if (!this.elements.submitBtn.dataset.originalContent) {
                        this.elements.submitBtn.dataset.originalContent = this.elements.submitBtn.innerHTML;
                    }

                    // Add accessible loading spinner
                    this.elements.submitBtn.innerHTML = `
                        <svg class="animate-spin h-5 w-5 mx-auto text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="sr-only">Processing...</span>
                    `;
                    this.elements.submitBtn.setAttribute('aria-busy', 'true');
                } else {
                    // Restore original content
                    if (this.elements.submitBtn.dataset.originalContent) {
                        this.elements.submitBtn.innerHTML = this.elements.submitBtn.dataset.originalContent;
                    }
                    this.elements.submitBtn.removeAttribute('aria-busy');

                    // Refocus input on desktop to allow rapid command entry
                    // Avoid on mobile to prevent virtual keyboard from obscuring content
                    if (window.innerWidth >= 768) {
                        this.elements.commandInput.focus();
                    }
                }
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.elements.narrativeContent.scrollTop = this.elements.narrativeContent.scrollHeight;
                }, 100);
            }
            
            
            loadSettings() {
                document.getElementById('performance-optimizations').checked = this.performanceOptimized;
                
                // Apply performance settings
                if (this.performanceOptimized) {
                    this.elements.performanceIndicator.textContent = '‚ö° Optimized';
                    this.elements.performanceIndicator.className = 'text-green-400';
                } else {
                    this.elements.performanceIndicator.textContent = '‚öôÔ∏è Standard';
                    this.elements.performanceIndicator.className = 'text-yellow-400';
                }
            }
            
            saveSettings() {
                const performanceEnabled = document.getElementById('performance-optimizations').checked;
                localStorage.setItem('performanceOptimized', performanceEnabled);
                this.performanceOptimized = performanceEnabled;
                
                // Apply settings
                this.loadSettings();
                
                // Close modal
                document.getElementById('settings-modal').classList.add('hidden');
                
                // Show confirmation
                this.addNarrative('‚öôÔ∏è Settings saved successfully!');
            }
            
            handleEvents(events) {
                events.forEach(event => {
                    if (event.type === 'memory' && event.count > 0) {
                        this.elements.memoryIndicator.innerHTML = `
                            <div class="text-sm text-gray-400">Story Memory</div>
                            <div class="text-tavern-400 font-bold animate-pulse-gentle">üìö Updated (+${event.count})</div>
                        `;
                        
                        setTimeout(() => {
                            this.elements.memoryIndicator.innerHTML = `
                                <div class="text-sm text-gray-400">Story Memory</div>
                                <div class="text-tavern-400 font-bold">üìö Active</div>
                            `;
                        }, 3000);
                    }
                });
            }
            
        }
        
        // Initialize the enhanced game interface
        document.addEventListener('DOMContentLoaded', () => {
            window.gameInterface = new EnhancedGameInterface();
        });
    </script>
</body>
</html>